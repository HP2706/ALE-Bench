from __future__ import annotations

from contextlib import AbstractContextManager, nullcontext as does_not_raise

import pytest

from ale_bench.result import (
    CaseResult,
    JudgeResult,
    ResourceUsage,
    Result,
)


@pytest.mark.parametrize(
    "resource_usage_1,resource_usage_2,expected",
    [
        pytest.param(ResourceUsage(), ResourceUsage(), ResourceUsage(), id="zero"),
        pytest.param(
            ResourceUsage(
                num_case_gen=1,
                num_case_eval=2,
                num_call_public_eval=3,
                num_call_private_eval=4,
                execution_time_case_eval=1000,
            ),
            ResourceUsage(
                num_case_gen=5,
                num_case_eval=6,
                num_call_public_eval=7,
                num_call_private_eval=8,
                execution_time_case_eval=2000,
            ),
            ResourceUsage(
                num_case_gen=6,
                num_case_eval=8,
                num_call_public_eval=10,
                num_call_private_eval=12,
                execution_time_case_eval=3000,
            ),
            id="normal",
        ),
        pytest.param(
            ResourceUsage(
                num_case_gen=100,
                num_case_eval=100,
                num_call_public_eval=4,
                num_call_private_eval=0,
                execution_time_case_eval=10000,
            ),
            ResourceUsage(num_case_gen=10),
            ResourceUsage(
                num_case_gen=110,
                num_case_eval=100,
                num_call_public_eval=4,
                num_call_private_eval=0,
                execution_time_case_eval=10000,
            ),
            id="case_gen",
        ),
        pytest.param(
            ResourceUsage(
                num_case_gen=100,
                num_case_eval=100,
                num_call_public_eval=4,
                num_call_private_eval=0,
                execution_time_case_eval=10000,
            ),
            ResourceUsage(num_case_eval=10, execution_time_case_eval=1000),
            ResourceUsage(
                num_case_gen=100,
                num_case_eval=110,
                num_call_public_eval=4,
                num_call_private_eval=0,
                execution_time_case_eval=11000,
            ),
            id="case_eval",
        ),
        pytest.param(
            ResourceUsage(
                num_case_gen=100,
                num_case_eval=100,
                num_call_public_eval=4,
                num_call_private_eval=0,
                execution_time_case_eval=10000,
            ),
            ResourceUsage(num_call_public_eval=1),
            ResourceUsage(
                num_case_gen=100,
                num_case_eval=100,
                num_call_public_eval=5,
                num_call_private_eval=0,
                execution_time_case_eval=10000,
            ),
            id="public_eval",
        ),
        pytest.param(
            ResourceUsage(
                num_case_gen=100,
                num_case_eval=100,
                num_call_public_eval=4,
                num_call_private_eval=0,
                execution_time_case_eval=10000,
            ),
            ResourceUsage(num_call_private_eval=1),
            ResourceUsage(
                num_case_gen=100,
                num_case_eval=100,
                num_call_public_eval=4,
                num_call_private_eval=1,
                execution_time_case_eval=10000,
            ),
            id="private_eval",
        ),
    ],
)
def test_resource_usage_add(
    resource_usage_1: ResourceUsage, resource_usage_2: ResourceUsage, expected: ResourceUsage
) -> None:
    assert resource_usage_1 + resource_usage_2 == expected


@pytest.mark.parametrize(
    "resource_usage_1,resource_usage_2,expected",
    [
        pytest.param(ResourceUsage(), ResourceUsage(), ResourceUsage(), id="zero"),
        pytest.param(
            ResourceUsage(
                num_case_gen=6,
                num_case_eval=8,
                num_call_public_eval=10,
                num_call_private_eval=12,
                execution_time_case_eval=3000,
            ),
            ResourceUsage(
                num_case_gen=1,
                num_case_eval=2,
                num_call_public_eval=3,
                num_call_private_eval=4,
                execution_time_case_eval=1000,
            ),
            ResourceUsage(
                num_case_gen=5,
                num_case_eval=6,
                num_call_public_eval=7,
                num_call_private_eval=8,
                execution_time_case_eval=2000,
            ),
            id="normal",
        ),
    ],
)
def test_resource_usage_sub(
    resource_usage_1: ResourceUsage, resource_usage_2: ResourceUsage, expected: ResourceUsage
) -> None:
    assert resource_usage_1 - resource_usage_2 == expected


@pytest.mark.parametrize(
    "case_results,allow_score_non_ac,context,overall_judge_result,overall_absolute_score,overall_relative_score",
    [
        pytest.param(
            [],
            True,
            pytest.raises(ValueError, match=r"The case results must not be empty\."),
            JudgeResult.INTERNAL_ERROR,
            0.0,
            0.0,
            id="empty",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                )
            ],
            True,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            998244353,
            None,
            id="case_eval_accepted",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                )
            ],
            False,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            998244353,
            None,
            id="case_eval_accepted_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    relative_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                )
            ],
            True,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            998244353,
            998244353,
            id="case_eval_accepted_with_relative_score",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    relative_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                )
            ],
            False,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            998244353,
            998244353,
            id="case_eval_accepted_with_relative_score_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.WRONG_ANSWER,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                )
            ],
            True,
            does_not_raise(),
            JudgeResult.WRONG_ANSWER,
            0,
            None,
            id="case_eval_wrong_answer",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.WRONG_ANSWER,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                )
            ],
            False,
            does_not_raise(),
            JudgeResult.WRONG_ANSWER,
            0,
            None,
            id="case_eval_wrong_answer_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=1,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=2,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=3,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=4,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=5,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            15,
            None,
            id="multiple_accepted",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=1,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=2,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=3,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=4,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=5,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            15,
            None,
            id="multiple_accepted_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=1,
                    relative_score=200000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=2,
                    relative_score=400000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=3,
                    relative_score=600000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=4,
                    relative_score=800000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=5,
                    relative_score=1000000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            15,
            3000000000,
            id="multiple_accepted_with_relative_score",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=1,
                    relative_score=200000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=2,
                    relative_score=400000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=3,
                    relative_score=600000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=4,
                    relative_score=800000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=5,
                    relative_score=1000000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            15,
            3000000000,
            id="multiple_accepted_with_relative_score_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=1,
                    relative_score=200000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=2,
                    relative_score=400000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=3,
                    relative_score=600000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=4,
                    relative_score=800000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=5,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            15,
            None,
            id="multiple_accepted_with_relative_score_missing",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=1,
                    relative_score=200000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=2,
                    relative_score=400000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=3,
                    relative_score=600000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=4,
                    relative_score=800000000,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=5,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.ACCEPTED,
            15,
            None,
            id="multiple_accepted_with_relative_score_missing_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.INTERNAL_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.WRONG_ANSWER,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.RUNTIME_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=1.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.INTERNAL_ERROR,
            0,
            None,
            id="multiple_cases_internal_error",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.INTERNAL_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.WRONG_ANSWER,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.RUNTIME_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=1.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.INTERNAL_ERROR,
            0,
            None,
            id="multiple_cases_internal_error_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.WRONG_ANSWER,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.RUNTIME_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=1.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.WRONG_ANSWER,
            998244353,
            None,
            id="multiple_cases_wrong_answer",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.WRONG_ANSWER,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.RUNTIME_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=1.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.WRONG_ANSWER,
            0,
            None,
            id="multiple_cases_wrong_answer_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.RUNTIME_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=1.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.RUNTIME_ERROR,
            998244353,
            None,
            id="multiple_cases_runtime_error",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.RUNTIME_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=1.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.RUNTIME_ERROR,
            0,
            None,
            id="multiple_cases_runtime_error_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.TIME_LIMIT_EXCEEDED,
            998244353,
            None,
            id="multiple_cases_time_limit_exceeded",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.TIME_LIMIT_EXCEEDED,
            0,
            None,
            id="multiple_cases_time_limit_exceeded_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    relative_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.TIME_LIMIT_EXCEEDED,
            998244353,
            998244353,
            id="multiple_cases_time_limit_exceeded_with_relative_score",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.TIME_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=2.2,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    relative_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.TIME_LIMIT_EXCEEDED,
            0,
            0,
            id="multiple_cases_time_limit_exceeded_with_relative_score_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.MEMORY_LIMIT_EXCEEDED,
            998244353,
            None,
            id="multiple_cases_memory_limit_exceeded",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.MEMORY_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=1.0,
                    memory_usage=2147483648,
                ),
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.MEMORY_LIMIT_EXCEEDED,
            0,
            None,
            id="multiple_cases_memory_limit_exceeded_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.OUTPUT_LIMIT_EXCEEDED,
            998244353,
            None,
            id="multiple_cases_output_limit_exceeded",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.OUTPUT_LIMIT_EXCEEDED,
                    message="",
                    absolute_score=0,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.OUTPUT_LIMIT_EXCEEDED,
            0,
            None,
            id="multiple_cases_output_limit_exceeded_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.COMPILATION_ERROR,
            0,
            None,
            id="multiple_cases_compilation_error",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.COMPILATION_ERROR,
            0,
            None,
            id="multiple_cases_compilation_error_not_allow_score_non_ac",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    relative_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            True,
            does_not_raise(),
            JudgeResult.COMPILATION_ERROR,
            0,
            0,
            id="multiple_cases_compilation_error_with_relative_score",
        ),
        pytest.param(
            [
                CaseResult(
                    judge_result=JudgeResult.COMPILATION_ERROR,
                    message="",
                    absolute_score=0,
                    relative_score=0,
                    execution_time=0.0,
                    memory_usage=0,
                ),
                CaseResult(
                    judge_result=JudgeResult.ACCEPTED,
                    message="",
                    absolute_score=998244353,
                    relative_score=998244353,
                    execution_time=0.5,
                    memory_usage=67108864,
                ),
            ],
            False,
            does_not_raise(),
            JudgeResult.COMPILATION_ERROR,
            0,
            0,
            id="multiple_cases_compilation_error_with_relative_score_not_allow_score_non_ac",
        ),
    ],
)
def test_result_model_post_init(
    case_results: list[CaseResult],
    allow_score_non_ac: bool,
    context: AbstractContextManager[None],
    overall_judge_result: JudgeResult,
    overall_absolute_score: int,
    overall_relative_score: int | None,
) -> None:
    with context:
        result = Result(
            allow_score_non_ac=allow_score_non_ac,
            case_results=case_results,
            resource_usage=ResourceUsage(),
        )
        assert result.overall_judge_result == overall_judge_result
        assert result.overall_absolute_score == overall_absolute_score
        if overall_relative_score is None:
            assert result.overall_relative_score is None
        else:
            assert result.overall_relative_score == overall_relative_score
